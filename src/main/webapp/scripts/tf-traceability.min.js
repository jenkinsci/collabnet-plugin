/*! tf-traceability 2016-04-22 */
angular.module("tfTraceability",[]),function(){function a(){this.setEndPoint=function(a){m=a},this.$get=["$http","$q","$rootScope","tfUtilService",function(a,c,d,e){return{fetchNthLevelAssociations:function(f){f.endPoint||(f.endPoint=m);var g=k(f);return b(a,c,e,g,f,d),g},getNthLevelAssociations:function(a){var b=k(a);return o[b]},getDataForId:function(a){return n[a]},getCache:function(){return o},getTimeAxisData:function(){return p},clearCache:l,getKey:k}}]}function b(a,b,d,e,f,g){if(o.hasOwnProperty(e))return g.$broadcast(e,!0),void g.$broadcast("timeaxisdata",p);if(!q.hasOwnProperty(e)){0===f.levelNum&&l();var h=k(f,-1);f.levelNum>0&&!o.hasOwnProperty(h)||(q[e]=!0,c(a,b,d,e,f,g))}}function c(a,b,c,f,g,i){var k=e(g.sourceType,f,c),l=k?a({method:"POST",url:g.endPoint,headers:j(g.token),data:e(g.sourceType,f,c)}):h(b);l.then(function(a){delete q[f];try{d(a.data,f,c),i.$broadcast("timeaxisdata",p),i.$broadcast(f,!0)}catch(b){d3.select("div.tf-associations-summary").append("div").attr("id","tf-associations-summary-error").attr("class","alert alert-danger"),d3.select("#tf-associations-summary-error").append("i").attr("class","fa fa-times-circle").style("font-weight","bold").text(" Error retrieving data or no data found.");try{onNoDataError()}catch(b){console.log("Error retrieving data.")}}})}function d(a,b,c){"string"==typeof a&&(a={items:[]});var d=a.hasOwnProperty("items")?a.items:a,e=a.source_display_data,f=a.work_item_urls;if("0:"===b.substr(0,2)&&d.length>1){var g=d.filter(function(a){return a.associated_activity_summary_ids.length>0});d=g.length>0?[g[0]]:[d[0]]}o[b]=d.filter(function(a){return!n.hasOwnProperty(a.id)}),o[b].forEach(function(a){a.created_at||(a.created_at=a.time_created),a.__massaged_date=c.getInternalDateString(a.created_at),a.__display_time=c.getTimeString(a.created_at),a.__display_date=c.getDateString(a.created_at),a.source_name="",i(a,e,f,c),n[a.id]=a,a.level=+b.split(":")[0]});var h=[];for(var j in o)h=h.concat(o[j]);h.sort(function(a,b){return new Date(a.created_at)-new Date(b.created_at)});var k=o["0"+b.substr(b.indexOf(":"))];if(k){var l=k[0],m=new Date(l.created_at),q=[],r=[];h.forEach(function(a){new Date(a.created_at)<m?q.push(a):r.push(a)});var s,t,u=c.getVal("svgWidth")||1e3,v=+u/2;v=0===q.length?50:0===r.length&&30*q.length>+u/3?+u-100:+u/2;var w=50,x=50;p={},p.post_origin={},p.pre_origin={},r.forEach(function(a){t=a.__massaged_date,normalizedY=100*(a.level+1),t in p.post_origin?(0===a.level?(s=v,a.cx=s):(s+=50,a.cx=s),a.cy=0===a.level?normalizedY+20:normalizedY):(0===a.level?(s=v,a.cx=s):(s+=70,a.cx=s),a.cx=p.post_origin[t]=s,a.cy=0===a.level?normalizedY+20:normalizedY),x=a.cx}),s=v,q.reverse().forEach(function(a){t=a.__massaged_date,normalizedY=100*(a.level+1),t in p.pre_origin?(s-=50,a.cx=s=p.pre_origin[t]=s,a.cy=0===a.level?normalizedY+20:normalizedY,last_visited_date=t):(s-=70,a.cx=p.pre_origin[t]=s,a.cy=0===a.level?normalizedY+20:normalizedY),w=a.cx}),c.setVal("minX",w),c.setVal("maxX",x)}}function e(a,b,c){var d=b.split(":"),e=parseInt(d.shift());return 0===e?f(a,d,c):g(e,d)}function f(a,b,c){var d="",e=b[0],f=b[1],g=b.slice(2).join(":"),h=c.getCanonicalType(a),i=r[h]||"remote_id",j=!1;switch(e){case"sak":d+='in_source ["'+f+'"]\n';break;case"sourceId":d+='field_contains ["source_id", ["'+f+'"]]\n';break;case"repository":d+='in_repository ["'+f+'"]\n';break;case"id":d+='field_contains ["id", ["'+f+'"]]\n',j=!0}return j||(d+='field_contains ["'+i+'", ["'+g+'"]]\n'),d}function g(a,b){var c=a-1,d=c+":"+b.join(":"),e=o[d];if(0!==e.length){var f=e.map(function(a){return a.id}),g='field_contains ["id", [';return f.forEach(function(a){g+='"'+a+'",'}),g=g.replace(/,$/,""),g+="]]\n",g+="associations\n",g+='sort_by ["created_at", "asc"]\n'}}function h(a){var b=a.defer();return b.resolve({data:{items:[]}}),b.promise}function i(a,b,c,d){if(b&&b.hasOwnProperty(a.source_id)){var e=b[a.source_id];if(a.source_name=e.name,e.hasOwnProperty("_links")){var f=e._links;a.__icon_url=f.hasOwnProperty("source_icon")?f.source_icon.href:f.type_icon.href}}c&&c.hasOwnProperty(a.id)?a.__remote_link=c[a.id]:a.__remote_link=d.getLinkFromObject(a)}function j(a){var b={Accept:"application/json"};return a&&(b["X-Orchestrate-Session"]=a,b["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8"),b}function k(a,b){b=b||0;var c=parseInt(a.levelNum)+parseInt(b);return c+":"+a.remoteSource+":"+a.remoteId}function l(){o={},n={},p={}}angular.module("tfTraceability").provider("tfQueryService",a);var m=null,n={},o={},p={},q={},r={commits:"revision_number"}}(),function(){function a(a,b,c){a.attr("width",b).attr("height",c)}function b(a,b){var c=d3.behavior.drag().on("drag",function(){var c=e(),f=20,g=C("maxX")||50,h=C("minX")||50,i=parseInt(d3.select("svg#tf-explore-svg").style("width")),j=c-d3.event.dx;j>g-100||h+100+2*f-i>j||(d(a),c=j,b.attr("transform","translate("+-c+",0)"),d3.select(b.node().parentNode).selectAll("g.dates").attr("transform","translate("+-c+",0)"))});a.call(c),a.on("mouseover",function(){d(a)}).on("mousedown",function(){a.style("cursor","move")}).on("mouseup",function(){a.style("cursor","default")})}function c(a,b){var c=d3.behavior.zoom().scaleExtent([1,10]).on("zoom",function(){b.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")});a.call(c)}function d(a){var b=function(b){d3.selectAll("g#tf-explore-levels").attr("transform","translate("+b+", 0)"),d3.selectAll("g#tf-explore-dates").attr("transform","translate("+b+", 0)"),d(a)},c=e(),f=d3.select("svg#tf-explore-svg").style("width"),g=f.indexOf("px")>0?parseInt(f):1e5,h=20,i=C("maxX")||50,j=C("minX")||50,k=i+h>g+c,l=c>j-h,m=l?"block":"none";d3.select(".tf-left-chevron").style("top","70px").style("display",m).on("mousedown",function(){b(d3.transform(d3.select("g#tf-explore-levels").attr("transform")).translate[0]+100)}),m=k?"block":"none",d3.select(".tf-right-chevron").style("top","70px").style("right","0px").style("display",m).on("mousedown",function(){b(d3.transform(d3.select("g#tf-explore-levels").attr("transform")).translate[0]-100)})}function e(){var a=d3.select("g#tf-explore-levels").attr("transform");return a?-1*parseInt(a.substr(a.indexOf("(")+1)):0}function f(a,b){var c=n(a,b),d=a.ns,e=d3.select("g#tf-"+d+"-levels defs");if(!(e.selectAll("pattern#"+c)[0].length>0)){var f=e.append("svg:pattern").attr("x",0).attr("y",0).attr("width",16).attr("height",16).attr("id",c);f.append("image").attr("xlink:href",b).attr("x",12).attr("y",11).attr("height",15).attr("width",16)}}function g(a,b,c,d,e){d3.selectAll("g#"+e.id+"_group").remove(),d3.selectAll("text#"+e.id+"_text").remove(),d3.selectAll("circle#"+e.id).remove(),d3.selectAll("circle#"+e.id+"_status_circle").remove(),d3.selectAll("text#"+e.id+"_status_text").remove(),d3.selectAll("rect#"+e.id+"_count_rect").remove(),d3.selectAll("text#"+e.id+"_count_text").remove(),d3.selectAll("path."+e.id).remove(),e.image&&f(a,e.image);var g=a.append("g").attr("id",e.id+"_group").attr("transform","translate("+b+","+c+")");e.text&&g.append("text").attr("id",e.id+"_text").attr("stroke",M).attr("text-anchor","middle").attr("x",0).attr("y",5).style("font-size","14px").text(e.text),g.append("circle").attr("cx",0).attr("cy",0).attr("r",d).attr("id",e.id).attr("class","node tf_level_"+e.level).style("stroke",e.stroke?e.stroke:M).style("stroke-width",e.strokewidth?e.strokewidth:"1px").style("fill",function(){return e.image?o(n(a,e.image)):"#ffffff"}).style("fill-opacity",function(){return e.image?1:0}).on("mouseover",function(){d3.select(this).style("stroke",e.mouseoverstroke?e.mouseoverstroke:L),d3.select(this).style("cursor","pointer")}).on("mouseout",function(){d3.select(this).style("stroke",e.mouseoutstroke?e.mouseoutstroke:M),d3.selectAll("circle.selected").style("stroke",e.mouseoutstroke?e.mouseoutstroke:L)}).on("mousedown",function(){e.onClickFun?e.onClickFun():(d3.selectAll("circle.node").style("stroke",e.mouseoverstroke?e.mouseoverstroke:M).classed("selected",!1),d3.select(this).style("stroke",e.mouseoutstroke?e.mouseoutstroke:L).classed("selected",!0),d3.selectAll("path.link").style("stroke",e.mouseoverstroke?e.mouseoverstroke:M),d3.selectAll("path."+e.id).style("stroke",e.mouseoutstroke?e.mouseoutstroke:L),d3.selectAll("path."+e.id).each(function(){this.parentNode.appendChild(this)}),e.hasOwnProperty("showDetailFun")&&e.showDetailFun(e.id))}).append("svg:title").text(e.toolTip),e.status&&h(a,b,c,d,45,e.status,e.id),e.hasOwnProperty("count")&&i(a,b,c,d,45,e.count,e.id)}function h(a,b,c,d,e,f,g){var h=m(b,c,d,e);a.append("circle").attr("id",g+"_status_circle").attr("cx",h.x+2).attr("cy",h.y).attr("r",5).style("stroke","white").style("fill","white"),a.append("text").attr("id",g+"_status_text").attr("width",14).attr("height",14).attr("x",h.x-6).attr("y",h.y+4).attr("font-family","FontAwesome").attr("fill",r(f)).style("background","white").text(function(a){return q(f)})}function i(a,b,c,d,e,f,g){var h,i=m(b,c,d,e);h=10*f.toString().length<20?15:10*f.toString().length,a.append("rect").attr("id",g+"_count_rect").attr("x",i.x-4).attr("y",i.y-8).attr("width",h).attr("height",15).attr("rx",4).attr("ry",4).style("stroke","black").style("fill","black"),a.append("text").attr("id",g+"_count_text").attr("x",i.x).attr("y",i.y+3).attr("fill","white").style("background","black").style("font-size","12px").text(function(a){return f})}function j(a,b,c,d){if(b.x!==c.x||b.y!==c.y){var e=l(b,c,d);a.append("path").style("stroke",M).attr("class","link "+b.id+" "+c.id).attr("d",e)}}function k(a,b,c,d){var e,f,g,h,i,k;try{e=+d3.selectAll("circle#"+b).attr("cx"),f=+d3.selectAll("circle#"+b).attr("cy"),g=+d3.selectAll("circle#"+b).attr("r"),h=+d3.selectAll("circle#"+c).attr("cx"),i=+d3.selectAll("circle#"+c).attr("cy"),k=+d3.selectAll("circle#"+c).attr("r"),j(a,{x:e,y:f,r:g,id:b},{x:h,y:i,r:k,id:c},d)}catch(l){console.log(l)}}function l(a,b,c){var d=a.x,e=b.x,f=a.y,g=b.y,h=100-a.r-b.r,i=[{x:0,y:0},{x:0,y:0}],j=" ";return e>d&&g===f?(i[0].x=a.x,i[0].y=a.y-a.r,i[1].x=b.x,i[1].y=b.y-b.r,"M"+a.x+","+(a.y-a.r)+j+"Q"+a.x+","+(a.y-2*a.r+6)+j+(a.x+a.r)+","+(a.y-a.r-2*(h/10))+j+"L"+(b.x-b.r)+","+(b.y-b.r-2*(h/10))+j+"Q"+b.x+","+(b.y-2*b.r+6)+j+b.x+","+(b.y-b.r)):e>d&&f>g?(i[0].x=a.x,i[0].y=a.y-a.r,i[1].x=b.x,i[1].y=b.y+b.r,0===c?"M"+a.x+","+(a.y-a.r)+j+"L"+a.x+","+(b.y+2*(h/10))+j+"Q"+a.x+","+(b.y+4)+j+(a.x+a.r/2)+","+b.y+j+"L"+(b.x-b.r)+","+b.y:"M"+i[0].x+","+i[0].y+j+"L"+i[0].x+","+(i[0].y-6*(h/10))+j+"Q"+i[0].x+","+(i[1].y+15)+j+(i[0].x+a.r/2)+","+(i[1].y+2*(h/10))+j+"L"+(i[1].x-b.r/2)+","+(i[1].y+2*(h/10))+j+"Q"+i[1].x+","+(i[1].y+10)+j+i[1].x+","+i[1].y):e===d&&f>g?(i[0].x=a.x,i[0].y=a.y-a.r,i[1].x=b.x,i[1].y=b.y+b.r,"M"+i[0].x+","+i[0].y+j+"L"+i[1].x+","+i[1].y):d>e&&f>g?(i[0].x=a.x,i[0].y=a.y-a.r,i[1].x=b.x,i[1].y=b.y+b.r,0===c?"M"+a.x+","+(a.y-a.r)+j+"L"+a.x+","+(b.y+2*(h/10))+j+"Q"+a.x+","+(b.y+4)+j+(a.x-a.r/2)+","+b.y+j+"L"+(b.x+b.r)+","+b.y:"M"+i[0].x+","+i[0].y+j+"L"+i[0].x+","+(i[0].y-6*(h/10))+j+"Q"+i[0].x+","+(i[1].y+15)+j+(i[0].x-a.r/2)+","+(i[1].y+2*(h/10))+j+"L"+(i[1].x+b.r/2)+","+(i[1].y+2*(h/10))+j+"Q"+i[1].x+","+(i[1].y+10)+j+i[1].x+","+i[1].y):d>e&&g===f?l(b,a,c):d>e&&g>f?l(b,a,c):e===d&&g>f?l(b,a,c):e>d&&g>f?l(b,a,c):void 0}function m(a,b,c,d){var e=Math.PI/180*d;return{x:a+c*Math.cos(e),y:b-c*Math.sin(e)}}function n(a,b){return a.ns+"_"+K(b).replace(/=/g,"")}function o(a){if(p()&&p()<10)return"url(#"+a+")";var b=d3.select("head>base")[0][0];return b?"url("+location.href+"#"+a+")":"url(#"+a+")"}function p(){return document.documentMode}function q(a){try{return T[V[a.toLowerCase()]]}catch(b){return T._missing}}function r(a){try{return U[V[a.toLowerCase()]]}catch(b){return U._missing}}function s(a){return W[a]||a}function t(a){switch(a._type){case"CommitSummary":return a.ctf_commit_url;case"BuildSummary":return a.build_url;case"ReviewRequestSummary":return a.link;default:return void 0}}function u(a){switch(a._type){case"WorkItemSummary":return a.closed?"successful":"open";case"CommitSummary":return;case"ReviewRequestSummary":case"BuildSummary":case"CustomSummary":return a.status_type}}function v(a){switch(a._type){case"WorkItemSummary":return a.closed?"Closed":"Open";case"CommitSummary":return"";case"ReviewRequestSummary":case"BuildSummary":case"CustomSummary":return z(a.status_name)}}function w(a,b,c){var d=y(b);d.levelNum=c,a.fetchNthLevelAssociations(d)}function x(a,b,c){var d=y(b);return d.levelNum=c,a.getKey(d)}function y(a){return{token:a.token,remoteId:a.remoteid,sourceType:a.sourcetype,remoteSource:a.remotesource,endPoint:a.endpoint}}function z(a){return void 0===a?"":0===a.length?a:1===a.length?a.toUpperCase():a.substr(0,1).toUpperCase()+a.substr(1).toLowerCase()}function A(a){var b=document.createElement("div");return b["textContent"in b?"textContent":"innerText"]=a,b.innerHTML}function B(a,b){N[a]=b}function C(a){return N[a]}function D(a){O=a}function E(a){P=a}function F(a){Q=a}function G(a){var b=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];if(S)return moment(a).tz(Q).format(R);var c=new Date(a);return b[c.getUTCMonth()]+" "+c.getUTCDate()+" "+c.getUTCFullYear()}function H(a){return S?moment(a).tz(Q).format(O):G(a)}function I(a){if(S)return moment(a).tz(Q).format(P);var b=new Date(a);return b.getUTCHours()+":"+b.getUTCMinutes()+":"+b.getUTCSeconds()+" GMT"}function J(){this.parentNode.appendChild(this);var a=d3.select(this),b=d3.event.dx+this.offsetLeft,c=d3.event.dy+this.offsetTop,d=this.parentNode.getBoundingClientRect();0>b||b>d.right-200||0>c||c>400||a.style({right:"auto",bottom:"auto",left:b+"px",top:c+"px"})}function K(a){for(var b,c,d,e,f,g,h,i="",j=0,k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=";j<a.length;)b=a.charCodeAt(j++),c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i=i+k.charAt(e)+k.charAt(f)+k.charAt(g)+k.charAt(h);return i}angular.module("tfTraceability").factory("tfUtilService",[function(){return{configureDragForNodes:b,configureSizeInSVG:a,configureZoomInSVG:c,connectNodes:j,connectNodesByIds:k,drawNode:g,getCanonicalType:s,getLinkFromObject:t,getStatusIcon:q,getStatusColor:r,getStatusFromObject:u,getStatusNameFromObject:v,fetchLevelN:w,makeKeyForLevelN:x,htmlEncode:A,showChevrons:d,setTimeFormat:E,setDateFormat:D,setTimeZone:F,getDateString:H,getTimeString:I,getInternalDateString:G,moveElement:J,setVal:B,getVal:C}}]);var L="#3dade0",M="#adbcc4",N={},O="MMM D YYYY",P="h:mm a",Q="GMT",R="MMM DD YYYY",S=void 0!==(moment&&moment.tz),T={successful:"",failure:"",pending:"",ignored:"",aborted:"",unstable:"",_missing:""},U={successful:"#ADCD49",failure:"#F94842",pending:"#F9DD00",ignored:"#ADBCC4",aborted:"#ADBCC4",unstable:"#FB782F",_missing:"#FFFFFF"},V={successful:"successful",success:"successful",closed:"successful",submitted:"successful",failure:"failure",failed:"failure",rejected:"failure",pending:"pending",open:"pending","new":"pending","in progress":"pending",ignored:"ignored",aborted:"aborted",discarded:"aborted",unstable:"unstable"},W={WorkItem:"work_items",work_item:"work_items",WorkItemSummary:"work_items",commit:"commits",Commit:"commits",CommitSummary:"commits",Review:"reviews",review:"reviews",ReviewRequestSummary:"reviews",build:"builds",Build:"builds",BuildSummary:"builds",custom:"custom",XDS:"custom",CustomSummary:"custom"}}(),function(){function a(a,b,c){function d(a,d,e){c(function(){var c=d3.select("svg#tf-explore-svg"),d=d3.select("g#tf-explore-levels");b.configureSizeInSVG(c,a.svgwidth,a.svgheight),b.setVal("svgWidth",d3.select("svg#tf-explore-svg")[0][0].clientWidth),b.setVal("ctfUrl",a.ctfurl),b.configureDragForNodes(c,d),a.dateformat&&b.setDateFormat(a.dateformat),a.timeformat&&b.setTimeFormat(a.timeformat),a.timezone&&b.setTimeZone(a.timezone)},0)}return{link:d,restrict:"E",template:'<div class="tf-associations-explore-chevrons"><div class="tf-left-chevron"><i class="fa fa-chevron-left"></i></div><div class="tf-right-chevron"><i class="fa fa-chevron-right"></i></div></div><svg id="tf-explore-svg"><g class="axis"><tf-traceability-timeaxis></tf-traceability-timeaxis></g><g class="levels" id="tf-explore-levels"><defs></defs><tf-traceability-level activity="explore" level="0"></tf-traceability-level><tf-traceability-level activity="explore" level="1"></tf-traceability-level><tf-traceability-level activity="explore" level="2" expandable="true"></tf-traceability-level></g></svg><div id="tf-associated-node-details"></div>',scope:{endpoint:"@",token:"@",remotesource:"@",sourcetype:"@",remoteid:"@",ctfurl:"@",dateformat:"@",timeformat:"@",timezone:"@",svgwidth:"@",svgheight:"@"}}}angular.module("tfTraceability").directive("tfTraceabilityExploration",["tfQueryService","tfUtilService","$timeout",a])}(),function(){function a(a,c,d){function e(b,d,e){c.fetchLevelN(a,b,0),b.$watch("levelScope.keyAvailable",function(f,i){if(f){d.children().remove();var j=f,k=d[0],l=d3.select(k);l.ns=e.activity;var m;if("summary"===l.ns)m=a.getCache()[j],h(b,+e.level,m,l);else{for(var n=parseInt(j),o=j.substr(j.indexOf(":")),p=0;n>=p;p++){var q=p+o,r=a.getCache()[q];g(b,p,r,l,n===p&&"true"===e.expandable,d)}var s=c.getVal("maxLevel")||2;b.showDetailsPopup&&n===s&&d3.selectAll("circle.tf_level_0").each(function(a,b){var c=d3.select(this).on("mousedown");c.apply(this,[a,b])}),d3.select("svg#tf-explore-svg").style("height",250+100*n+"px")}}})}function f(c,d){var e,f=this,g={token:c.token,remoteId:c.remoteid,sourceType:c.sourcetype,remoteSource:c.remotesource,endPoint:c.endpoint,levelNum:+d.level},h=a.getKey(g,-1),i=a.getKey(g);e=c.$on(h,function(b,c){c&&a.fetchNthLevelAssociations(g)}),b.push(e),e=c.$on(i,function(a,b){f.keyAvailable=i}),b.push(e)}function g(b,e,f,g,h,k){for(var l,m,n=function(e){var f=e.replace("explore_orc_",""),g=a.getDataForId(f),h=j(g),i=d3.select("div#tf-associated-node-details");i.selectAll("*").remove(),i.append("a").classed("tf-explore-close",!0).style({"float":"right",cursor:"pointer","font-size":"20px","line-height":"18px",color:"#1787ba","font-weight":"normal","margin-right":"8px","margin-top":"8px"}).attr("xlink:href","#").html("&times;").on("mouseover",function(){this.style.textDecoration="none"}).on("click",function(){b.showDetailsPopup=!1,i.style("display","none")}),i.append("div").style("margin-left","4px").style("margin-right","4px").html(function(){var a="";return h.statusIcon&&(a+='<span class="fa fa-fw" style="color:'+h.statusColor+';">'+h.statusIcon+"</span>&nbsp;"),a+='<span class="tf-association-id" style="color: #3CADE0;">'+h.id+"</span>"}),i.append("div").style("margin-left","4px").style("margin-right","4px").html('<img src="'+h.sourceIcon+'"></img>&nbsp;<span class="tf-association-source">'+h.sourceName+"</span>"),i.append("br"),h.fields.forEach(function(a){i.append("div").style("margin-left","4px").style("margin-right","4px").html(a[0]+": "+(c.htmlEncode(a[1])||"").replace(/\n/g,"<br />"))});var l=i.append("div").style("text-align","center"),m=l.append("button").classed("btn-primary",!0).classed("btn-xs",!0).style("margin","10px").text("SET AS TARGET"),n=l.append("button").classed("btn-info",!0).classed("btn-xs",!0).style("margin","10px").text(h.linkLabel);m.on("click",function(){b.$apply(function(){b.$parent.remotesource="id:"+f,b.$parent.remoteid=h.id,b.$parent.sourcetype="",p(),a.clearCache();var e=k.parent();e.find("g").remove();var g=d('<tf-traceability-level activity="explore" level="0"></tf-traceability-level><tf-traceability-level activity="explore" level="1"></tf-traceability-level><tf-traceability-level activity="explore" level="2" expandable="true"></tf-traceability-level>')(b);c.setVal("maxLevel",2),e.append(g),i.style("display","none")})}),n.on("click",function(){window.location=h.link||""}),i.style("display","block"),b.showDetailsPopup=!0,i.call(d3.behavior.drag().on("drag",c.moveElement))},m=0;m<f.length;m++){l=f[m];var o=(l._type,g.ns+"_orc_"+l.id);c.drawNode(g,l.cx,l.cy,20,{id:o,level:e,status:c.getStatusFromObject(l),toolTip:(l.source_name||i(l._type))+"\nID: "+(l.remote_id||l.revision_number)+"\nAt: "+l.__display_date+" "+l.__display_time,image:l.__icon_url,showDetailFun:n})}if(0!==e){for(var q,r=function(){b.$apply(function(){var a=d('<tf-traceability-level activity="explore" level="'+e+'"></tf-traceability-level><tf-traceability-level activity="explore" level="'+(e+1)+'" expandable="true"></tf-traceability-level>')(b),f=d3.select("div#tf-associated-node-details");c.setVal("maxLevel",e+1),f.style("display","none");var g=k.parent();k.remove(),g.append(a)})},m=0;m<f.length;m++){l=f[m];var s=l.associated_activity_summary_ids;q=0;for(var t=0;t<s.length;t++){var u=s[t],v=a.getDataForId(u);void 0!==v&&(v.level===e-1||v.level===e)?c.connectNodes(g,{x:l.cx,y:l.cy,r:20,id:"explore_orc_"+l.id},{x:v.cx,y:v.cy,r:20,id:"explore_orc_"+v.id},e-1):q++}if(h&&q>0){var w=q+" more association"+(1===q?"":"s");c.drawNode(g,l.cx,l.cy+100,20,{id:g.ns+"_orc_"+l.id+"_assocs",toolTip:w,text:"+"+q,onClickFun:r}),c.connectNodes(g,{x:l.cx,y:l.cy,r:20,id:"explore_orc_"+l.id},{x:l.cx,y:l.cy+100,r:20,id:"explore_orc_"+l.id+"_assocs"},e)}}d3.selectAll("g#tf-explore-levels").attr("transform","translate(0, 0)"),d3.selectAll("g#tf-explore-dates").attr("transform","translate(0, 0)"),c.showChevrons(g)}}function h(a,b,d,e){var f,g=80,h=25;if(0===b)return f=e.ns+"_orc_"+d[0].id,void c.drawNode(e,g,h,20,{id:f,status:c.getStatusFromObject(d[0]),toolTip:(d[0].source_name||i(d[0]._type))+"\nID: "+(d[0].remote_id||d[0].revision_number),image:d[0].__icon_url});for(var j=80,k=70,l={},m={},n={},o={},p=0,q=0;q<d.length;q++){var r=d[q],s=r.__icon_url?r.source_name:r._type;s=s||r._type,m[s]=r.__icon_url,l[s]=l.hasOwnProperty(s)?l[s]+1:1,n[s]=s===r._type?i(s):s,p++,o[s]=e.ns+"_orc_"+p}0===d.length&&(l.none=0,m.none=void 0,n.none="No Associations",o.none=e.ns+"_orc_none");for(var t in l)j+=70,c.drawNode(e,j,k,20,{id:o[t],toolTip:n[t],count:l[t],image:"none"!==t?m[t]:void 0}),c.connectNodes(e,{x:j,y:k,r:20,id:o[t]},{x:g,y:h,r:20,id:"summary_orc_"+f},0)}function i(a){var b={CommitSummary:"Commit",WorkItemSummary:"Work Item",BuildSummary:"Build",ReviewRequestSummary:"Review Request",CustomSummary:"Custom Type",none:"No Associations"};return b[a]||a}function j(a){var b=c.getVal("ctfUrl"),d=c.getVal("imageLocation"),e={CommitSummary:k,WorkItemSummary:l,BuildSummary:m,ReviewRequestSummary:n,CustomSummary:o};return e[a._type](a,b,d)}function k(a,b,d){var e;try{e=b+"/sf/go/"+a.ctf_item.ctf_id}catch(f){e=""}return{fields:[["By",a.created_by],["At",a.__display_date+" "+a.__display_time],["Comment",a.message]],sourceIcon:a.__icon_url,sourceName:a.source_name,statusIcon:c.getStatusIcon("success"),statusColor:c.getStatusColor("success"),id:a.revision_number,linkLabel:"SEE COMMIT",link:a.__remote_link}}function l(a,b,d){return{fields:[["Summary",a.summary],["By",a.created_by],["At",a.__display_date+" "+a.__display_time],["Priority",a.priority],["Status",c.getStatusNameFromObject(a)]],sourceIcon:a.__icon_url,id:a.remote_id,statusIcon:c.getStatusIcon(c.getStatusFromObject(a)),statusColor:c.getStatusColor(c.getStatusFromObject(a)),sourceName:a.source_name,linkLabel:"SEE WORK ITEM",link:a.__remote_link||b+"/sf/go/"+a.remote_id}}function m(a,b,d){var e="",f=["ignored","failed","passed"];return f.forEach(function(b){var c="test_results_"+b+"_count";a[c]>0&&(e+=a[c]+" "+b+". ")}),{fields:[["Status",c.getStatusNameFromObject(a)],["Initiated By",a.created_by],["At",a.__display_date+" "+a.__display_time],["Duration",a.duration+" seconds"],["Results",e]],sourceIcon:a.__icon_url,id:a.remote_id,statusIcon:c.getStatusIcon(c.getStatusFromObject(a)),statusColor:c.getStatusColor(c.getStatusFromObject(a)),sourceName:a.source_name,linkLabel:"SEE BUILD RESULTS",link:a.__remote_link}}function n(a,b,d){return{fields:[["Status",c.getStatusNameFromObject(a)],["Initiated By",a.created_by],["At",a.__display_date+" "+a.__display_time]],sourceIcon:a.__icon_url,id:a.remote_id,statusIcon:c.getStatusIcon(c.getStatusFromObject(a)),statusColor:c.getStatusColor(c.getStatusFromObject(a)),sourceName:a.source_name,linkLabel:"SEE REVIEW REQUEST",link:a.__remote_link}}function o(a,b,d){return{fields:[["Summary",a.summary||a.description],["By",a.created_by],["At",a.__display_date+" "+a.__display_time],["Status",c.getStatusNameFromObject(a)]],sourceIcon:a.__icon_url,id:a.remote_id,statusIcon:c.getStatusIcon(c.getStatusFromObject(a)),statusColor:c.getStatusColor(c.getStatusFromObject(a)),sourceName:a.source_name,linkLabel:"SEE ACTIVITY",link:a.__remote_link||b+"/sf/go/ORC_"+a.opaque_id}}function p(){for(var a;a=b.pop();)a()}return{templateNamespace:"svg",type:"svg",link:e,restrict:"E",template:'<g class="nodes"></g>',scope:!0,replace:!0,controller:["$scope","$attrs",f],controllerAs:"levelScope"}}angular.module("tfTraceability").directive("tfTraceabilityLevel",["tfQueryService","tfUtilService","$compile",a]);var b=[]}(),function(){function a(a,b){function c(c,d,f){b.fetchLevelN(a,c,0),c.$watch("summaryData.dataAvailableFor",function(f,g){if(f){var h=d.find("svg")[0],i=d3.select(h),j=d.find("g")[0];d3.select(j);c.dataAvailable||(c.svgheight="1px"),b.configureSizeInSVG(i,c.svgwidth,c.svgheight);var k=a.getCache()[f],l=d3.select(d.find("div")[0]);e(k,l,c)}})}function d(c){c.dateformat&&b.setDateFormat(c.dateformat),c.timeformat&&b.setTimeFormat(c.timeformat),c.timezone&&b.setTimeZone(c.timezone);var d=b.makeKeyForLevelN(a,c,0),e=b.makeKeyForLevelN(a,c,1);c.$on(d,function(d,e){c.dataAvailable=e,e&&b.fetchLevelN(a,c,1)}),c.$on(e,function(a,b){c.summaryData={dataAvailableFor:e}})}function e(a,c,d){var e=d.ctfurl,g=2,h=3,i=5,j=["Date","By","","ID","Source","Status","Summary"],k=["date","by","typeicon","id","source","status","summary"],l=a.map(function(a){return f(a,d)}),m=c.append("div").classed("tf-associations-list",!0),n=m.append("table").classed("tf-associations-list",!0),o=n.append("tr");o=o.selectAll("th").data(j).enter().append("th").attr("class",function(a,b){return"tf-associations-col-"+k[b]}).text(function(a){return a}),o=n.selectAll("tr.dont-skip-row").data(l).enter().append("tr"),o.selectAll("td").data(function(a){return l.pop()}).enter().append("td").attr("class",function(a,b){return"tf-associations-col-"+k[b]}).html(function(a,c){if(c===h&&a.indexOf("~")>0){var d=a.split("~"),f=0===d[0].indexOf("http")?d[0]:e+"/sf/go/"+d[0];return'<a href="'+f+'">'+d[1]+"</a>"}if(c===g)return'<img src="'+a+'"/>';if(c===i){var j="",k=b.getStatusIcon(a);if(k){var l=b.getStatusColor(a);j='<span class="fa fa-fw" style="color:'+l+';">'+k+"&nbsp;</span>"}return j+a}return a}),o.selectAll(".tf-associations-col-summary, .tf-associations-col-id").on("mouseenter",function(){var a=d3.select(this);this.offsetWidth<this.scrollWidth&&!a.attr("title")&&a.attr("title",a.text())})}function f(a,b){var c={CommitSummary:g,WorkItemSummary:h,ReviewRequestSummary:j,BuildSummary:i,CustomSummary:k};return c[a._type](a)}function g(a){return[a.__display_date,a.created_by,a.__icon_url,a.__remote_link+"~"+a.revision_number,a.source_name,"",a.message]}function h(a){return[a.__display_date,a.created_by,a.__icon_url,a.__remote_link+"~"+a.remote_id,a.source_name,b.getStatusNameFromObject(a),a.summary]}function i(a){var c="";a.hasOwnProperty("duration")&&(c+="Duration: "+a.duration+" seconds. ");var d="Test results: ",e=!1,f=["ignored","failed","passed"];return f.forEach(function(b){var c="test_results_"+b+"_count";a[c]>0&&(d+=a[c]+" "+b+". ",e=!0)}),e&&(c+=d),[a.__display_date,a.created_by,a.__icon_url,a.__remote_link+"~"+a.remote_id,a.source_name,b.getStatusNameFromObject(a),c]}function j(a){return[a.__display_date,a.created_by,a.__icon_url,a.__remote_link+"~"+a.remote_id,a.source_name,b.getStatusNameFromObject(a),a.summary]}function k(a){return[a.__display_date,a.created_by,a.__icon_url,a.__remote_link||"ORC_"+a.opaque_id+"~"+a.remote_id,a.source_name,b.getStatusNameFromObject(a),a.summary]}return{link:c,restrict:"E",scope:{endpoint:"@",token:"@",sourcetype:"@",remotesource:"@",remoteid:"@",ctfurl:"@",dateformat:"@",timeformat:"@",timezone:"@",svgwidth:"@",svgheight:"@"},controller:["$scope",d],template:'<div class="tf-associations-summary"><svg height="1px"><g class="levels" id="tf-summary-levels"><defs></defs><tf-traceability-level activity="summary" level="0"></tf-traceability-level><tf-traceability-level activity="summary" level="1" show="typecount"></tf-traceability-level></g></svg></div>'}}angular.module("tfTraceability").directive("tfTraceabilitySummary",["tfQueryService","tfUtilService",a])}(),function(){function a(a,b){function c(a,b,c){a.$watch("timeaxisScope.orcData",function(a,c){if(a){angular.element(b.children()[1]).children().remove();var d=b.children()[1],e=d3.select(d);["post_origin","pre_origin"].forEach(function(b){temp_array=[];for(var c in a[b])temp_array.push(c);temp_array.sort(function(a,b){return new Date(a)-new Date(b)});var d;temp_array.forEach(function(c){dateSplitUp=c.split(" ");var f,g=new Date(c);void 0===d||d.getFullYear()!=g.getFullYear()?(d=new Date(c),f=dateSplitUp[0].toUpperCase()+" '"+dateSplitUp[2].slice(-2)):f=d.getMonth()!=g.getMonth()?dateSplitUp[0].toUpperCase():"",f&&e.append("text").classed("tf-calendar-icon",!0).attr("font-family","FontAwesome").attr("font-size","13px").attr("x",a[b][c]-25).attr("y",23).text(""),e.append("text").attr("id",b+c).classed("tf-calendar-mmyy",!0).attr("x",a[b][c]-10).attr("y",23).attr("fill","#0D171A").text(f),e.append("text").classed("tf-calendar-dd",!0).attr("x",a[b][c]-5).attr("y",55).attr("fill","#0D171A").text(function(){return 1===dateSplitUp[1].length?"0"+dateSplitUp[1]:dateSplitUp[1]}),d=new Date(c)})})}},!0)}function d(a,b){var c=this;a.$on("timeaxisdata",function(a,b){c.orcData=b})}return{templateNamespace:"svg",type:"svg",link:c,restrict:"E",template:'<g><g class="axislines"><path d="M0 4 L100000 0" stroke="#D5DCDD" stroke-width="1px" fill="none"/><path d="M0 35 L99990 35" stroke="#D5DCDD" stroke-width="1px" fill="none"/><path d="M0 70 L100000 70" stroke="#D5DCDD" stroke-width="1px" fill="none"/></g><g class="dates" id="tf-explore-dates"></g></g>',scope:!0,replace:!0,controller:["$scope","$attrs",d],controllerAs:"timeaxisScope"}}angular.module("tfTraceability").directive("tfTraceabilityTimeaxis",["tfQueryService","tfUtilService",a])}();